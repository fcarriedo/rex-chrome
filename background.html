<html>
  <head>
    <script src='resources/js/jquery.min.js'></script>
    <script src='resources/js/rex.js'></script>
  </head>
  <body>
    <script>
      function startBgService() {
        var authCtx = retrieveCredentials();
        if( authCtx ) {
          authCtx.success = initLiveFeed;
          authCtx.error = retryLater;

          validateCredentials(authCtx);
        } else {
          retryLater();
        }
      }

      function initLiveFeed() {
        listenToLiveFeed( liveFeedObserver.notify );
        console.log('Credentials verified and initializing feed.');
      }

      function retryLater() {
        var retrySec = 30;
        setTimeout(startBgService, retrySec*1000);
        console.log('Couldnt auth. Retrying agin in ' + retrySec + ' seconds.');
      }

      var liveFeedObserver = function() {
        var listeners = [];
        return {
          notify : function( data ) {
            //console.log( JSON.stringify(data) );
            for(var i=0; i<listeners.length; i++ ) {
              listeners[i].call(this, data);
            }
          },
          addListener: function( callback ) {
            listeners.push( callback );
          }
        };
      }();

      /* Messages listener */
      liveFeedObserver.addListener( function(messages) {
        for(var i=0; i<messages.length; i++ ) {
          var msg = messages[i];
          if( msg.kind === 'direct-message') {
            var title = 'New Private Message';
            var body = '"' + msg.message + '" - ' + msg.user.username;
            showSimpleNotification(title, body);
          }
        }
      });

      /* Mentions listener */
      liveFeedObserver.addListener( function(messages) {
        for(var i=0; i<messages.length; i++ ) {
          var msg = messages[i];
          if( msg.kind === 'message') {
            // TODO(fcarriedo): Refactor. Expensive to create RegEx obj per msg.
            var usrHandleRegex = new RegExp("(^|[^a-zA-Z])(@" + getUsername() + ")([^a-zA-Z]|$)", 'i');
            if( usrHandleRegex.test(msg.message) ) {
              var title = 'New Mention';
              var body = '"' + msg.message + '" - ' +  msg.user.username;
              showSimpleNotification(title, body);
            }
          }
        }
      });

      /* Topic listener */
      liveFeedObserver.addListener( function(messages) {
        for(var i=0; i<messages.length; i++ ) {
          var msg = messages[i];
          if( msg.kind === 'topic') {
            var title = 'New Topic Created';
            var body = '"' + msg.name + '"';
            showSimpleNotification(title, body);
          }
        }
      });

      // Start the background service.
      startBgService();
    </script>
  </body>
</html>
