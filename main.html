<html>
  <head>
    <link rel="stylesheet" href="resources/css/rex.css" type="text/css"/>
    <script src='resources/js/jquery.min.js'></script>
    <script src='resources/js/jquery.tmpl.min.js'></script>
    <script src='resources/js/underscore-min.js'></script>
    <script src='resources/js/backbone-min.js'></script>
    <script src='resources/js/rex.js'></script>
    <script>
      $(document).ready(function() {
        setTimeout(initRex, 50); // To show a 'loading' msg while loading main content.
      });

      function login() {
        var usr = $('#usr').val();
        var pswd = $('#pswd').val();

        var authCtx = {
          username: usr,
          password: pswd,
          success: function() {
            showMainPane();
            getBackgroundPage().startBgService();
          },
          error: function() {
            showLoginError();
          }
        };

        validateCredentials( authCtx );
      }

      function logout() {
        removeCredentials();
        setupGlobalCreds(null, null);
        showLoginPage();
      }

      function showLoginPage() {
        $('#content-pane').hide();
        $('#login').fadeIn();
      }

      function showMainPane() {
        $('#login').hide();
        $('#content-pane').fadeIn();
        fetchGroups(function(groups) {
          $('#groups-content').html( $('#group-tmpl').tmpl(groups) );
        });
      }

      function showLoginError() {
        $('#login-err').text('Wrong credentials');
        setTimeout(function() {$('#login-err').text('');}, 7000);
      }



      // TODO(fcarriedo): Do a $('#container').scrollTo('#id');
      // Slide to
      function slideToTopics(groupId) {
        $('#content-pane').animate({"left": "-=350px"}, "normal");
        fetchTopics( groupId , function(topics) {
          $('#topics-content').html( $('#topic-tmpl').tmpl(topics) );
        });
      }

      function slideToMessages(topicId) {
        $('#content-pane').animate({"left": "-=350px"}, "normal");
        fetchMessages( topicId , function(messages) {
          $('#messages-content').html( $('#message-tmpl').tmpl(messages) );
        });
      }

    </script>
  </head>
  <body>
    <div id='header'>
      <h1><img src='resources/images/rex.png' title='rex'/> rex</h1>
      <div id='subtitle'>(A Convore Chrome Extension)</div>
    </div>

    <div id='login' style='display: none'>
      <div id='login-err' class='error'></div>
      <table>
        <tr><td>Username:</td><td><input id='usr' type='text'/></td></tr>
        <tr><td>Password:</td><td><input id='pswd' type='password'/></td></tr>
        <tr><td colspan='2'><button onClick='login()'>Login</button></td></tr>
      </table>
    </div>

    <div id='content-pane'>

      <!-- Groups pane -->
      <div id="groups-pane">
        <div id='groups-content'><span class='loading'>Loading...</span></div>
        <h5><a href='#' onClick='logout()'>logout</a></h5>
      </div>

      <!-- Topics pane -->
      <div id="topics-pane" onClick='slideTo()'>
        Topics pane
        <div id='topics-content'><span class='loading'>Loading...</span></div>
        <h5><a href='#' onClick='logout()'>logout</a></h5>
      </div>

      <!-- messages pane -->
      <div id="messages-pane">
        Messages pane
        <div id='messages-content'><span class='loading'>Loading...</span></div>
        <h5><a href='#' onClick='logout()'>logout</a></h5>
      </div>

    </div>



    <!-- jQuery template definitions (groups, topics, messages, users, etc.) -->

    <!-- Groups template -->
    <script id='group-tmpl' type=text/x-jquery-tmpl'>
      <div class='group' onClick='slideToTopics( ${id} )'>
        <img src='${creator.img}' title='${creator.username}'/>
        <a href='#' onClick='openInConvore("${url}")'>${name}</a>
        <span class='topic'> Topics: ${topics_count} </span>
      </div>
    </script>

    <!-- Topics template -->
    <script id='topic-tmpl' type=text/x-jquery-tmpl'>
      <div class='topic' onClick='slideToMessages( ${id} )'>
        ${name} - <i class='loading'>by ${creator.username} - Total messages: ${message_count} - <b>${unread}</b> unread</i>
      </div>
    </script>

    <!-- Messages template -->
    <script id='message-tmpl' type=text/x-jquery-tmpl'>
      <div class='message'>
        ${message} - <i class='loading'>by ${user.username}</i>
      </div>
    </script>

    <!-- Users template -->
    <script id='user-tmpl' type=text/x-jquery-tmpl'>
      <div class='user'>
      </div>
    </script>

  </body>
</html>
