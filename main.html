<html>
  <head>
    <link rel="stylesheet" href="resources/css/rex.css" type="text/css"/>
    <script src='resources/js/jquery.min.js'></script>
    <script src='resources/js/jquery.tmpl.min.js'></script>
    <script src='resources/js/convore-api.js'></script>
    <script src='resources/js/rex.js'></script>
    <script>
      $(document).ready(function() {
        setTimeout(function() {
          verifyAccount(
            function(usrDetails){
              initUi(usrDetails);
            },
            function() {
              showLoginPage(); // On account verification error.
            }
          );
        }, 50); // To show a 'loading' msg while loading main content.
      });

      function login() {
        var creds = {
          username: $('#usr').val(),
          password: $('#pswd').val()
        }

        authenticate(creds,
          function(usrDetails){
            initUi(usrDetails);
          },
          function(){
            showLoginError();
          }
        );
      }

      function logout() {
        doLogout();
        showLoginPage();
      }

      function initUi(usrDetails) {

        setLoadingMsg('#groups-pane .content-box');

        $('#msg-form img').attr('src', usrDetails.img);

        initUiBehaviors();

        // Clear the badge.
        badgeUtils.clearBadge();

        showMainPane();
      }

      function initUiBehaviors() {
        keyboardActions.initBindings();

        $('div.group, div.topic').live('mouseover mouseout', function(event) {
          if (event.type == 'mouseover') {
            $(this).addClass('clickable');
          } else {
            $(this).removeClass('clickable');
          }
        });
      }

      function showLoginPage() {
        $('#main-view-pane').hide();
        $('#notifications-pane').hide();
        $('#login').fadeIn();
        $('#logout').hide();
      }

      function showMainPane() {
        clearLoginForm();
        $('#login').hide();
        $('#main-view-pane').fadeIn();
        $('#notifications-pane').fadeIn();
        $('#logout').fadeIn();
        convoreApi.fetchGroups(function(groups) {
          console.log(groups);
          $('#groups-pane .content-box').html( $('#group-tmpl').tmpl(groups) );
        });
      }

      function showLoginError() {
        $('#login-err').text('Wrong credentials');
        setTimeout(function() {$('#login-err').text('');}, 7000);
      }

      function clearLoginForm() {
        $('#usr').val('');
        $('#pswd').val('');
      }



      // TODO(fcarriedo): Do a $('#container').scrollTo('#id');
      // Slide to
      function slideToTopics( elem ) {

        setLoadingMsg('#topics-pane .content-box');

        keyboardActions.setMode( keyboardActions.modes.topics );

        $('#full-pane').animate({"left": "-=350px"}, "normal");

        var groupId = $(elem).attr('id').split('-')[1];
        $('#topics-group-title').text( $(elem).find('.info').text() );

        convoreApi.fetchGroupTopics( groupId , function(topics) {
          $('#topics-pane .content-box').html( $('#topic-tmpl').tmpl(topics) );
        });
      }

      function slideToMessages( elem ) {

        setLoadingMsg('#messages-pane .content-box');

        keyboardActions.setMode( keyboardActions.modes.messages );

        $('#full-pane').animate({"left": "-=350px"}, "normal");

        var topicId = $(elem).attr('id').split('-')[1];
        $('#messages-topic-title').text( $(elem).find('.info').text() );

        convoreApi.fetchTopicMessages( topicId , function(messages) {
          $('#messages-pane .content-box').html( $('#message-tmpl').tmpl(messages) );

          // We linkify all rendered messages.
          $('#messages-pane .info-box .info').each( function(index) {
            $(this).html( linkUtils.linkify( $(this).html() ) );
          });
        });
      }

      function scrollBack(mode) {
        keyboardActions.setMode( mode );

        // Make sure that the msg form is cleared
        $('#msg-form textarea').val('');
        $('#msg-form textarea').blur();

        $('#full-pane').animate({"left": "+=350px"}, "normal");
      }

      function setLoadingMsg(selector) {
        $(selector).html('<span class="small metadata">Loading...</span>');
      }

     /** ======================================
      *   Keyboard bindings
      *  ======================================
      */

      var keyboardActions = function() {

        var keyMap = {
          up: 38, down: 40, left: 37, right: 39, help: 63,
          h: 104, j: 106, k: 107, l: 108, m: 109, r: 114, o: 111,
          enter: 13
        };

        var modes = {
          groups: 'groups', topics: 'topics', messages: 'messages'
        };

        var currentMode = modes.groups; // Default mode: groups.

        function getPaneSelectorFromCurrentMode() {
          return '#' + currentMode + '-pane .content-box';
        }

        function down(evt) {
          var pane = $( getPaneSelectorFromCurrentMode() );
          var selectedElem = pane.find('.selected');
          if( selectedElem.length === 0 ) {
            pane.children('.info-box').first().addClass('selected');
          } else {
            var nextElem = selectedElem.next();
            selectedElem.removeClass('selected');
            nextElem.addClass('selected');
          }
        }

        function up(evt) {
          var pane = $( getPaneSelectorFromCurrentMode() );
          var selectedElem = pane.find('.selected');
          if( selectedElem.length === 0 ) {
            pane.children('.info-box').last().addClass('selected');
          } else {
            var previousElem = selectedElem.prev();
            selectedElem.removeClass('selected');
            previousElem.addClass('selected');
          }
        }

        function left(evt) {
          if( currentMode === modes.topics ) {
            scrollBack(modes.groups);
          } else if( currentMode === modes.messages ) {
            scrollBack(modes.topics);
          }
        }

        function right(evt) {
          if( currentMode !== modes.messages ) {
            var pane = $( getPaneSelectorFromCurrentMode() );
            var selectedElem = pane.find('.selected');
            if( selectedElem.length !== 0 ) {
              if( currentMode === modes.groups ) {
                slideToTopics( selectedElem );
              } else if( currentMode === modes.topics ) {
                slideToMessages( selectedElem );
              }
            }
          }
        }

        function reply(evt) {
          if(currentMode === modes.messages) {
            var pane = $( getPaneSelectorFromCurrentMode() );
            var selectedElem = pane.find('.selected');
            if( selectedElem.length !== 0 ) {
              var replyToUserHandle = '@' + selectedElem.find('.creator-username').text() + ' ';
              $('#msg-form textarea').focus().val( replyToUserHandle );
              evt.preventDefault();
            }
          }
        }

        function message(evt) {
          if(currentMode === modes.messages) {
            $('#msg-form textarea').focus();
            evt.preventDefault();
            var pane = $( getPaneSelectorFromCurrentMode() );
            var selectedElem = pane.find('.selected');
            if( selectedElem.length !== 0 ) {
              selectedElem.removeClass('selected');
            }
          }
        }

        function enter(evt) {
          if(currentMode === modes.messages) {
            var msg = $('#msg-form textarea').val();
            if( $.trim(msg) !== '' ) {
              // Create a message object send it and add it to the list on success.
            }

            $('#msg-form textarea').blur(); // Make it loose focus.
          }
        }

        function open(evt) {
          console.log('opening in convore site');
        }

        function help(evt) {
          console.log('asking for help');
        }

        return {

          modes: modes,

          setMode: function(newMode) {
            currentMode = newMode;
          },

          initBindings: function() {

            $(document).keypress(function(evt) {
              var keyCode = evt.which;

              if( $('#msg-form textarea').is(':focus') && currentMode === modes.messages && keyCode !== keyMap.enter ) {
                return;
              }

              switch(keyCode) {

                case keyMap.down:
                case keyMap.j:
                  down(evt);
                  break;

                case keyMap.up:
                case keyMap.k:
                  up(evt);
                  break;

                case keyMap.left:
                case keyMap.h:
                  left(evt);
                  break;

                case keyMap.right:
                case keyMap.l:
                  right(evt);
                  break;

                case keyMap.r:
                  reply(evt);
                  break;

                case keyMap.m:
                  message(evt);
                  break;

                case keyMap.enter:
                  enter(evt);
                  break;

                case keyMap.o:
                  open(evt);
                  break;

                case keyMap.help: // '?'
                  help(evt);
                  break;

                default:
                  break;

              }
            });
          }
        };
      }();
    </script>
  </head>
  <body>

    <!-- Header section -->
    <div id="header">
      <div id="header-top">
        <div id="header-logo">
          <h1 class='shadow-text'><img src='resources/images/rex.png' title='rex'/> rex</h1>
        </div>
        <div id="notifications-pane">
          <div class="badge">
            <div id='mentions-badge-text' class="badge-text">15</div>
            <a href='#' onClick='openInConvore("/mentions")' title='mentions'><img src='resources/images/mention.png'></a>
          </div>
          <div class="badge">
            <div id='messages-badge-text' class="badge-text">7</div>
            <a href='#' onClick='openInConvore("/messages")' title='messages'><img src='resources/images/message.png' title='messages'></a>
          </div>
        </div>
      </div>
      <div id="header-bottom">
        <div id="subtitle" class='shadow-text'>(A Convore Chrome Extension)</div>
        <div id="logout" style='display: none'><a href='#' onClick='logout()'>logout</a></div>
      </div>
    </div>

    <!-- Login pane -->
    <div id='login' style='display: none'><br/>
      <div id='login-err' class='small error'></div>
      <table>
        <tr><td>Username:</td><td><input id='usr' type='text'/></td></tr>
        <tr><td>Password:</td><td><input id='pswd' type='password'/></td></tr>
        <tr><td colspan='2'><button onClick='login()'>Login</button></td></tr>
      </table>
    </div>

  <div id='main-view-pane'>

    <div id='full-pane'>

      <!-- Groups pane -->
      <div id='groups-pane' class='content-pane'>
        <div class='title'>
          <b>Groups</b>
        </div><br/>
        <div class='content-box'>
          <!-- Here goes the content. -->
        </div>
      </div>

      <!-- Topics pane -->
      <div id='topics-pane' class='content-pane'>
        <div class='title'>
          <img src='resources/images/group.png' width='15px'/> <b><span id='topics-group-title'></span></b>
        </div>
        <div class='back-link'><a href='#' onClick='scrollBack("groups")'>Back to Groups</a></div>
        <div class='content-box'>
          <!-- Here goes the content. -->
        </div>
      </div>

      <!-- Messages pane -->
      <div id='messages-pane' class='content-pane'>
        <div class='title'>
          <img src='resources/images/chat.png' width='15px'/> <b><span id='messages-topic-title'></span></b>
        </div>
        <div class='back-link'><a href='#' onClick='scrollBack("topics")'>Back to Topics</a></div>
        <div class='content-box'>
          <!-- Here goes the content. -->
        </div>

        <div id='msg-form'>
          <div><img title='You!'/></div>
          <div><textarea id='new-message'></textarea></div>
          <div><a href='#' id='submit' onClick=''>Submit</a></div>
        </div>

      </div>

    </div>



    <!-- jQuery template definitions (groups, topics, messages, users, etc.) -->

    <!-- Groups template -->
    <script id='group-tmpl' type=text/x-jquery-tmpl'>
      <div id='group-${id}' class='info-box' onClick='slideToTopics( this )'>
        <div class='pic'><img src='${creator.img}' title='${creator.username}'/></div>
        <div class='info-container'>
          <div class='info'>${name}</div>
          <div class='small metadata'>Topics: ${topics_count}</div>
        </div>
      </div>
    </script>

    <!-- Topics template -->
    <script id='topic-tmpl' type=text/x-jquery-tmpl'>
      <div id='topic-${id}' class='info-box' onClick='slideToMessages( this )'>
        <div class='pic'><img src='${creator.img}' title='${creator.username}'/></div>
        <div class='info-container'>
          <div class='info'>${name}</div>
          <div class='small metadata'>Total messages: ${message_count} - <b>${unread}</b> unread</i></div>
        </div>
      </div>
    </script>

    <!-- Messages template -->
    <script id='message-tmpl' type=text/x-jquery-tmpl'>
      <div id='message-${id}' class='info-box'>
        <div class='pic'><img src='${user.img}' title='${user.username}'/></div>
        <div class='info-container'>
          <div class='info'>${message}</div>
          <div class='small metadata'>by <span class='creator-username'>${user.username}</span></div>
        </div>
      </div>
    </script>

    <!-- Users template -->
    <script id='user-tmpl' type=text/x-jquery-tmpl'>
      <div class='user'>
      </div>
    </script>

  </body>
</html>
